CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -I./src
BISON = bison
FLEX = flex

SRCDIR = src
BUILDDIR = build
TARGET = $(BUILDDIR)/minilang

SRCS = $(SRCDIR)/ast.c $(SRCDIR)/symbol.c $(SRCDIR)/interpreter.c $(SRCDIR)/main.c
OBJS = $(BUILDDIR)/ast.o $(BUILDDIR)/symbol.o $(BUILDDIR)/interpreter.o $(BUILDDIR)/main.o
PARSER_SRCS = $(BUILDDIR)/parser.tab.c $(BUILDDIR)/lex.yy.c
PARSER_OBJS = $(BUILDDIR)/parser.tab.o $(BUILDDIR)/lex.yy.o

.PHONY: all build run test clean interactive help

all: build

build: $(TARGET)

$(TARGET): $(OBJS) $(PARSER_OBJS)
	$(CC) -o $@ $^ -lm
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(TARGET)"

$(BUILDDIR)/%.o: $(SRCDIR)/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(BUILDDIR)/parser.tab.c: $(SRCDIR)/parser.y
	$(BISON) -d $< -o $@

$(BUILDDIR)/lex.yy.c: $(SRCDIR)/lexer.l
	$(FLEX) -o $@ $<

$(BUILDDIR)/parser.tab.o: $(BUILDDIR)/parser.tab.c
	$(CC) $(CFLAGS) -c $< -o $@

$(BUILDDIR)/lex.yy.o: $(BUILDDIR)/lex.yy.c
	$(CC) $(CFLAGS) -c $< -o $@

# è¿è¡Œå•ä¸ªæ–‡ä»¶
run: build
ifneq ($(FILE),)
	@if [ -f "$(FILE)" ]; then \
		echo "ğŸš€ è¿è¡Œ: $(FILE)"; \
		echo "========================================"; \
		./$(TARGET) "$(FILE)"; \
		echo "========================================"; \
	else \
		echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $(FILE)"; \
		echo "å¯ç”¨æ–‡ä»¶:"; \
		ls examples/*.mylang 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ç¤ºä¾‹æ–‡ä»¶"; \
	fi
else
	@echo "âŒ è¯·æŒ‡å®šæ–‡ä»¶: make run FILE=examples/hello.mylang"
	@echo "å¯ç”¨æ–‡ä»¶:"; \
	ls examples/*.mylang 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ç¤ºä¾‹æ–‡ä»¶"
endif

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: build
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	@if [ -d "examples" ]; then \
		for file in examples/*.mylang; do \
			if [ -f "$$file" ]; then \
				echo ""; \
				echo "ğŸ“ è¿è¡Œ: $$file"; \
				echo "========================================"; \
				./$(TARGET) "$$file"; \
				echo "========================================"; \
				echo ""; \
			fi; \
		done; \
	else \
		echo "â„¹ï¸  ç¤ºä¾‹ç›®å½•ä¸å­˜åœ¨"; \
	fi

# æ¸…ç†
clean:
	@rm -rf $(BUILDDIR)/
	@echo "ğŸ§¹ æ¸…ç†å®Œæˆ"

# äº¤äº’æ¨¡å¼
interactive:
	@chmod +x build.sh
	@./build.sh interactive

# å¸®åŠ©
help:
	@echo "ğŸ“– MyLang ç¼–è¯‘å™¨ Makefile å¸®åŠ©"
	@echo "ç”¨æ³•: make [ç›®æ ‡]"
	@echo ""
	@echo "ç›®æ ‡:"
	@echo "  build        ç¼–è¯‘é¡¹ç›®"
	@echo "  run FILE=... è¿è¡ŒæŒ‡å®šæ–‡ä»¶"
	@echo "  test         è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  clean        æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  interactive  äº¤äº’æ¨¡å¼"
	@echo "  help         æ˜¾ç¤ºå¸®åŠ©"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make build"
	@echo "  make run FILE=examples/hello.mylang"
	@echo "  make test"
	@echo "  make interactive"